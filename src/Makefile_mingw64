# Use GNU Make to process this file
MATLABROOT=C:\Program Files\MATLAB\R2011b
MATLABLIBS=-lmwlapack -lmwblas
MATLABLINKFLAGS=-L"$(MATLABROOT)\bin\win64" $(MATLABLIBS)

#CC = i686-pc-mingw32-gcc 
CC=gcc

CFLAGS=-O3 -s -Wall -std=c99 -m64 -I../thirdparty -I./
DIRECTIVES=-DCOMPILING_LTFAT -DLTFAT_DLL_NEVERUSED -D_WIN32 -D_WINDOWS -D_USRDLL -DLTFAT_BACKEND_EXPORTS

toCompile = \
  dgt.c dgt_fac.c dgt_fb.c dgt_multi.c dgt_ola.c dgt_shear.c \
  dgt_walnut.c dgtreal_fac.c dwilt.c filterbank.c heapint.c idgt_fac.c idgt_fb.c \
  iwfac.c pfilt.c reassign.c spread.c tfutil.c wavelets.c wfac.c \
  windows.c winmanip.c c-safe-memalloc.c integer_manip.c 
  
toCompileNoType = \


#files_blaslapack = \
#	sgabdual.o sgabtight.o sgabdual_fac.o sgabtight_fac.o \
#	dgabdual.o dgabtight.o dgabdual_fac.o dgabtight_fac.o 	

#files_unix = $(files) $(files_blaslapack) dltfat_blaslapack.o sltfat_blaslapack.o
#files_matlab = $(files) $(files_blaslapack) dltfat_blaslapack_matlab.o sltfat_blaslapack_matlab.o

FILESBASE  = $(basename $(toCompile))
FILESBASEO = $(addsuffix .o,$(FILESBASE))
DFILES = $(addprefix d,$(FILESBASEO))
SFILES = $(addprefix s,$(FILESBASEO))


all: double single

double: $(DFILES) $(toCompileNoType)
	$(CC) -shared -Wl,--out-implib=../mex/ltfat_dll.lib \
	-Wl,--dll $(DFILES) $(toCompileNoType) \
	-o ../mex/ltfat.dll -static-libgcc ltfat_notdllexport.def -L../mex -lfftw3-3
	del *.o *.a
  
single: $(SFILES)  
	$(CC) -shared -Wl,--out-implib=../mex/ltfatf_dll.lib \
	-Wl,--dll $(SFILES) \
	-o ../mex/ltfatf.dll -static-libgcc -L../mex -lfftw3-3 -lfftw3f-3
	del *.o *.a

s%.o: %.c config.h
	$(CC) $(CFLAGS) $(DIRECTIVES) -DLTFAT_SINGLE  -c $< -o s$*.o

d%.o: %.c config.h
	$(CC) $(CFLAGS) $(DIRECTIVES) -DLTFAT_DOUBLE  -c $< -o d$*.o

%.o: %.c
	$(CC) $(CFLAGS) $(DIRECTIVES) -c $<

clean:
	del ..\mex\ltfat.dll
	del ..\mex\ltfat_dll.lib
	del ..\mex\ltfatf.dll
	del ..\mex\ltfatf_dll.lib
	del *.o *.a
