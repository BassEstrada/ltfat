As = -60;
fp = 8000/44100/2;
alpha = -cos(pi*fp);
alpha1 = (1-sqrt(1-alpha^2))/alpha;

[b,a,z,p,k]=halfbandiir('minorder',.45,10^(As/10));

p =roots(a);
zplane(b,a)

beta = sort(abs(p(imag(p)>0)).^2);

fileID = fopen('filtcoefs.h','w');

expstring = ...
['/*\n This file is autogenerated. Do not edit! \n', ...
 '*/\n'];

betaString = sprintf('%.16e, ', beta );


fprintf(fileID,expstring);
fprintf(fileID,'#define EMQFCOEFLEN %i\n',numel(beta));
fprintf(fileID,'static const double EMQFcoef[]={ %s};\n',betaString(1:end-1));

fclose(fileID);



betaemqf = (beta+alpha1^2)./(beta*alpha1^2+1);

% Allpass filters
beta1 = beta(1:2:end);
beta2 = beta(2:2:end);

A0b = [beta1,zeros(numel(beta1),1),ones(numel(beta1),1)];
A0a = fliplr(A0b);

A1b = [beta2,zeros(numel(beta2),1),ones(numel(beta2),1)];
A1a = fliplr(A1b);

% Make the last filters /2
A0b(end,:) = A0b(end,:);
A1b(end,:) = A1b(end,:);

% Reassemble back
A0ball = A0b(1,:);
A0aall = A0a(1,:);
A1ball = A1b(1,:);
A1aall = A1a(1,:);

for ii = 2:size(A0b,1)
   A0ball = conv(A0ball,A0b(ii,:)); 
   A0aall = conv(A0aall,A0a(ii,:));
end

for ii = 2:size(A1b,1)
   A1ball = conv(A1ball,A1b(ii,:)); 
   A1aall = conv(A1aall,A1a(ii,:)); 
end

A1ball = [0,A1ball];
A1aall = [A1aall,0];

% Aball = A1ball + A0ball;
% Aaall = A1aall + A0aall;


A0 = freqz(A0ball,A0aall);
A1 = freqz(A1ball,A1aall);

plot(20*log10(abs(A0+A1)))


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Allpass filters
betaemqf1 = betaemqf(1:2:end);
betaemqf2 = betaemqf(2:2:end);

A0b = [betaemqf1,alpha*(1+betaemqf1),ones(numel(beta1),1)];
A0a = fliplr(A0b);

A1b = [betaemqf2,alpha*(1+betaemqf2),ones(numel(beta2),1)];


A1a = fliplr(A1b);

x = randn(10000,1);


% Reassemble back
A0ball = A0b(1,:);
A0aall = A0a(1,:);
A1ball = A1b(1,:);
A1aall = A1a(1,:);    
    
for ii = 2:size(A0b,1)
   A0ball = conv(A0ball,A0b(ii,:)); 
   A0aall = conv(A0aall,A0a(ii,:));
   
end

for ii = 2:size(A1b,1)
   A1ball = conv(A1ball,A1b(ii,:)); 
   A1aall = conv(A1aall,A1a(ii,:)); 
end

A1ball = conv(A1ball,[alpha1,1]); 
A1aall = conv(A1aall,[1,alpha1]); 



A0 = freqz(A0ball,A0aall);
A1 = freqz(A1ball,A1aall);

subplot(2,1,1);
plot(20*log10(abs(A0+A1)))

subplot(2,1,2);
plot((unwrap(angle(A0+A1))))




